---
title: "CISH, SOCS gene expression for PRLvsHPG birds"
author: "Victoria Farrar"
date: "12/15/2019"
output: html_document
---
```{r setup}
library(tidyverse)
library(ggsignif)
library(cowplot)
library(effsize) #effect sizes and cohen's d
library(stringr) #sample name cleanup
cq<-read.csv("~/Desktop/data/2019-12-13_full_PRLvsHPG_POA_PVN_qPCR_data.csv", header=TRUE) #uncleaned data
samp<-read.csv(file="~/Desktop/data/PRLvsHPG_sample_key.csv") #Sample data with sex and stage, will be used for joins later

#data cleanup
samp$bird_id<-as.factor(samp$bird_id)
cq$sample<-as.character(cq$sample)
cq$sample<-str_remove(cq$sample, "ROPI_") #remove ROPI_ prefix from sample names to make uniform
colnames(cq)[3]<- "bird_id"  #rename sample to bird_id for join 


cq <-separate(data = cq, col = bird_id, into = c("bird_id", "nuclei"), sep = "_") #error here will be for H2O wells

cq$gene <-as.factor(cq$gene)
cq$bird_id <-as.factor(cq$bird_id)
cq$nuclei <-as.factor(cq$nuclei)

#sample size check 
cq %>%
  group_by(gene,nuclei) %>%
  drop_na(nuclei)%>%
  summarize(n= length(unique(bird_id)))
```

```{r triplicate cleanup}
#GOAL: to remove triplicates that are distant from the mean in those sample:gene combos that have a standard deviation > 1 in the triplicates 
cq_clean<- cq %>%
  drop_na(nuclei) %>%
  group_by(bird_id, nuclei, gene)%>%
  mutate(mean_cq = mean(cq, na.rm = TRUE), #average cq value across triplicates
         sd_cq = sd(cq, na.rm = TRUE), #sd across triplicates
         dist_mean = abs(cq - mean(cq))) %>% #for each sample, distance from mean cq 
  ungroup()
  
large_sd <- cq_clean %>%
  filter(sd_cq >1) %>%
  group_by(bird_id, nuclei, gene) %>%
  mutate(new_cq = ifelse(dist_mean == max(dist_mean), NA, cq)) %>%
  ungroup()
  
small_sd <- cq_clean %>%
  filter(sd_cq < 1) %>%
  group_by(bird_id, nuclei, gene) %>%
  mutate(new_cq = cq)

cq_clean_2<-rbind.data.frame(large_sd, small_sd)

#sample size checks
cq_clean %>%
  group_by(gene,nuclei) %>%
  summarize(n= length(unique(bird_id)))

cq_clean_2 %>%
  group_by(gene,nuclei) %>%
  summarize(n= length(unique(bird_id)))
```

```{r sample averages }
#calculate averages for each sample:nuclei combo

#using the unjoined data file, collapse mean across each triplicate. 
cq_dat<- cq_clean_2 %>%
    group_by(bird_id, nuclei, gene) %>% 
    summarise(mean_cq = mean(new_cq, na.rm = TRUE),
              sd_cq = sd(new_cq, na.rm=TRUE)) 

mean(cq_dat$sd_cq, na.rm=TRUE) #average sd 

#produce wide dataframe where each gene is a column
cq_wide <- cq_dat %>%
  select(-sd_cq) %>%
  pivot_wider(names_from = gene, values_from = mean_cq)
```

```{r ref genes and join}
#ref_gene calculation
#mean is not that different from geometric mean for two numbers
cq_wide$ref_gene <- rowMeans(cq_wide[c('GAPDH', 'HPRT1')], na.rm=TRUE) 

#join to get treatment and sex data 
qpcr_dat<-left_join(cq_wide, samp)

qpcr_dat$treatment<-factor(qpcr_dat$treatment, levels=c("vehicle","PRL")) #manually re-orders stages
qpcr_dat$bird_id<-as.factor(qpcr_dat$bird_id) #bird_id back to factor 

qpcr_dat <- qpcr_dat %>% drop_na(sex) #drops 1 bird (615) that does not have information
```

```{r ddct / fold change}
#NOTE: THIS CODE DOES NOT DIFFERENTIATE NUCLEI 

#calculate dct for CISH/SOCS with new reference genes 
qpcr_dat$dct_cish<- (qpcr_dat$CISH - qpcr_dat$ref_gene) #delta CT CISH
qpcr_dat$dct_socs1<- (qpcr_dat$SOCS1 - qpcr_dat$ref_gene) #delta CT SOCS1
qpcr_dat$dct_socs2<- (qpcr_dat$SOCS2 - qpcr_dat$ref_gene) #delta CT SOCS2

#control (? DO I NEED TO DIFFERENTIATE NUCLEI HERE?)
control_cish<-mean(qpcr_dat$dct_cish[qpcr_dat$treatment=="vehicle"], na.rm = TRUE)
control_socs1<-mean(qpcr_dat$dct_socs1[qpcr_dat$treatment=="vehicle"], na.rm = TRUE)
control_socs2<-mean(qpcr_dat$dct_socs2[qpcr_dat$treatment=="vehicle"], na.rm = TRUE)

#delta delta Ct 
qpcr_dat$ddct_cish<- (qpcr_dat$dct_cish - control_cish)
qpcr_dat$ddct_socs1<- (qpcr_dat$dct_socs1 - control_socs1)
qpcr_dat$ddct_socs2<- (qpcr_dat$dct_socs2 - control_socs2)

#fold change
qpcr_dat$fold_cish<-2^-(qpcr_dat$ddct_cish)
qpcr_dat$fold_socs1<-2^-(qpcr_dat$ddct_socs1)
qpcr_dat$fold_socs2<-2^-(qpcr_dat$ddct_socs2)

```

```{r GnIH-R}
#plot histogram of fold changes
hist(poa_dat$fold_gnihr)
hist(-(poa_dat$ddct_gnihr))
#log transform if non-normal
poa_dat$log_gnihr<-log2(poa_dat$fold_gnihr)
hist(poa_dat$log_gnihr) #more normalish
#plot sex by treatment 

ggplot(poa_dat, aes(x=treatment, y=log_gnihr,color=sex)) +
  geom_point(aes(shape=sex),position=position_jitter(width=0.1), size = 4)+
  #geom_text(aes(label = bird_id))+
  geom_boxplot(alpha=0.25, color="black")+
  scale_color_manual(values=c("purple", "orange"))+
  scale_x_discrete(labels=c("vehicle\n(6f:4m)", "PRL\n(9f:9m)"))+
  geom_signif(comparisons=list(c("vehicle", "PRL")), annotations="d= 0.55, n.s.",
              y_position = 5, tip_length = 0.05, vjust = 0, color="black", textsize = 5 )+
  labs(x= NULL, y="GnIH-R relative expression \n(log fold change)")+
  ylim(values=c(-5,5))+
  theme_classic()+ 
  theme(text = element_text(size=24), axis.text.x = element_text(size=16), legend.position = "none")

#model for gnih
m_gnihr<-lm(log_gnihr~treatment+sex, poa_dat)
anova(m_gnihr)
summary(m_gnihr) #not significant

shapiro.test(m_gnihr$residuals) #normal residuals, no need for lmRob

cohen.d.formula(log_gnihr ~ treatment, data=poa_dat) #cohen's d CI overlaps with 0, indicating no sig effect

```

